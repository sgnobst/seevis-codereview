package com.seevis.codereview.service;

import lombok.extern.slf4j.Slf4j;
import org.kohsuke.github.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.util.List;

@Service
@Slf4j
public class WebhookService {
    
    @Autowired
    private AIReviewService aiReviewService;
    
    @Value("${github.app.id:}")
    private String appId;
    
    @Value("${github.app.private-key-path:}")
    private String privateKeyPath;
    
    @Value("${GITHUB_TOKEN:}")
    private String githubToken;
    
    @Async
    public void processCodeReview(String repoFullName, int prNumber, String installationId) {
        log.info("üöÄ Starting async code review for {} PR #{}", repoFullName, prNumber);
        
        try {
            // GitHub Ïó∞Í≤∞ (App Ïù∏Ï¶ù ÎòêÎäî PAT ÏÇ¨Ïö©)
            GitHub github = createGitHubClient(installationId);
            
            // Repository Í∞ÄÏ†∏Ïò§Í∏∞
            GHRepository repository = github.getRepository(repoFullName);
            
            // Pull Request Í∞ÄÏ†∏Ïò§Í∏∞
            GHPullRequest pullRequest = repository.getPullRequest(prNumber);
            
            log.info("üìã PR Title: {}", pullRequest.getTitle());
            log.info("üë§ Author: {}", pullRequest.getUser().getLogin());
            log.info("üîÄ {} -> {}", pullRequest.getHead().getRef(), pullRequest.getBase().getRef());
            
            // PRÏóê ÎùºÎ≤® Ï∂îÍ∞Ä (Î¶¨Î∑∞ Ï§ë)
            try {
                pullRequest.addLabels("ai-reviewing");
            } catch (Exception e) {
                log.warn("Could not add label: {}", e.getMessage());
            }
            
            // Î≥ÄÍ≤ΩÎêú ÌååÏùº Í∞ÄÏ†∏Ïò§Í∏∞
            List<GHPullRequestFileDetail> files = pullRequest.listFiles().toList();
            log.info("üìÅ Files changed: {}", files.size());
            
            int totalComments = 0;
            
            // Í∞Å ÌååÏùºÏóê ÎåÄÌï¥ Î¶¨Î∑∞ Ïã§Ìñâ
            for (GHPullRequestFileDetail file : files) {
                // ÌååÏùº ÌôïÏû•Ïûê Ï≤¥ÌÅ¨
                if (!shouldReviewFile(file.getFilename())) {
                    log.debug("Skipping file: {}", file.getFilename());
                    continue;
                }
                
                log.info("üîç Reviewing: {}", file.getFilename());
                
                // ÏΩîÎìú Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ ÏÉùÏÑ±
                com.seevis.codereview.model.CodeChange codeChange = 
                    new com.seevis.codereview.model.CodeChange();
                codeChange.setFileName(file.getFilename());
                codeChange.setStatus(file.getStatus());
                codeChange.setAdditions(file.getAdditions());
                codeChange.setDeletions(file.getDeletions());
                codeChange.setPatch(file.getPatch());
                
                // AI Î¶¨Î∑∞ Ïã§Ìñâ
                com.seevis.codereview.model.ReviewResult result = 
                    aiReviewService.reviewCode(codeChange);
                
                // Î¶¨Î∑∞ Í≤∞Í≥ºÎ•º PR ÏΩîÎ©òÌä∏Î°ú ÏûëÏÑ±
                if (result != null && result.getIssues() != null && !result.getIssues().isEmpty()) {
                    StringBuilder comment = new StringBuilder();
                    comment.append("## ü§ñ AI Code Review for `").append(file.getFilename()).append("`\n\n");
                    
                    if (result.getSummary() != null && !result.getSummary().isEmpty()) {
                        comment.append("**Summary:** ").append(result.getSummary()).append("\n\n");
                    }
                    
                    comment.append("### Issues Found:\n\n");
                    
                    for (com.seevis.codereview.model.ReviewIssue issue : result.getIssues()) {
                        // Ïã¨Í∞ÅÎèÑÏóê Îî∞Î•∏ Ïù¥Î™®ÏßÄ
                        String emoji = "‚ÑπÔ∏è";
                        if ("error".equals(issue.getSeverity())) {
                            emoji = "üî¥";
                        } else if ("warning".equals(issue.getSeverity())) {
                            emoji = "üü°";
                        }
                        
                        comment.append(emoji).append(" **").append(issue.getType().toUpperCase())
                               .append("** ");
                        
                        if (issue.getLine() != null) {
                            comment.append("(Line ").append(issue.getLine()).append(")");
                        }
                        
                        comment.append("\n");
                        comment.append("- **Issue:** ").append(issue.getMessage()).append("\n");
                        
                        if (issue.getSuggestion() != null && !issue.getSuggestion().isEmpty()) {
                            comment.append("- **Suggestion:** ").append(issue.getSuggestion()).append("\n");
                        }
                        
                        comment.append("\n");
                    }
                    
                    // Í∏çÏ†ïÏ†ÅÏù∏ ÌîºÎìúÎ∞± Ï∂îÍ∞Ä
                    if (result.getPositives() != null && !result.getPositives().isEmpty()) {
                        comment.append("### ‚úÖ Good Practices:\n");
                        for (String positive : result.getPositives()) {
                            comment.append("- ").append(positive).append("\n");
                        }
                    }
                    
                    // PRÏóê ÏΩîÎ©òÌä∏ ÏûëÏÑ±
                    pullRequest.comment(comment.toString());
                    totalComments++;
                    
                    log.info("üìù Posted review comment for {}", file.getFilename());
                }
            }
            
            // ÎùºÎ≤® ÏóÖÎç∞Ïù¥Ìä∏ (Î¶¨Î∑∞ ÏôÑÎ£å)
            try {
                pullRequest.removeLabel("ai-reviewing");
                pullRequest.addLabels("ai-reviewed");
            } catch (Exception e) {
                log.warn("Could not update labels: {}", e.getMessage());
            }
            
            // Ï†ÑÏ≤¥ Î¶¨Î∑∞ ÏöîÏïΩ ÏΩîÎ©òÌä∏
            if (totalComments > 0) {
                String summary = String.format(
                    "## ‚úÖ Code Review Complete!\n\n" +
                    "I've reviewed **%d file(s)** and left **%d comment(s)**.\n\n" +
                    "Please review the feedback and make necessary improvements.\n\n" +
                    "_Powered by AI Code Reviewer with Google Gemini_ ü§ñ",
                    files.size(), totalComments
                );
                pullRequest.comment(summary);
            } else {
                pullRequest.comment(
                    "## ‚úÖ Code Review Complete!\n\n" +
                    "No significant issues found. Good job! üëç\n\n" +
                    "_Powered by AI Code Reviewer with Google Gemini_ ü§ñ"
                );
            }
            
            log.info("‚úÖ Code review completed for {} PR #{}", repoFullName, prNumber);
            
        } catch (Exception e) {
            log.error("‚ùå Error during code review for {} PR #{}", repoFullName, prNumber, e);
            
            // ÏóêÎü¨ Î∞úÏÉù Ïãú PRÏóê ÏΩîÎ©òÌä∏ ÎÇ®Í∏∞Í∏∞
            try {
                GitHub github = createGitHubClient(installationId);
                GHRepository repository = github.getRepository(repoFullName);
                GHPullRequest pullRequest = repository.getPullRequest(prNumber);
                
                pullRequest.comment(
                    "## ‚ùå Code Review Failed\n\n" +
                    "An error occurred during the code review process.\n" +
                    "Error: " + e.getMessage() + "\n\n" +
                    "Please try again or contact the administrator."
                );
                
                // ÎùºÎ≤® Ï†ïÎ¶¨
                try {
                    pullRequest.removeLabel("ai-reviewing");
                    pullRequest.addLabels("ai-review-failed");
                } catch (Exception labelError) {
                    log.warn("Could not update labels: {}", labelError.getMessage());
                }
                
            } catch (Exception commentError) {
                log.error("Could not post error comment", commentError);
            }
        }
    }
    
    private GitHub createGitHubClient(String installationId) throws IOException {
        // GitHub App Ïù∏Ï¶ù ÏÇ¨Ïö© (privateKeyÍ∞Ä ÏûàÎäî Í≤ΩÏö∞)
        if (appId != null && !appId.isEmpty() && 
            privateKeyPath != null && !privateKeyPath.isEmpty() && 
            installationId != null && !installationId.isEmpty()) {
            
            try {
                log.info("üîê Using GitHub App authentication");
                
                // Private key ÏùΩÍ∏∞
                File privateKeyFile = new File(privateKeyPath);
                String privateKey = Files.readString(privateKeyFile.toPath());
                
                // GitHub AppÏúºÎ°ú Ïù∏Ï¶ù
                GHAppInstallationToken token = GitHub.connectUsingOAuth(appId)
                    .getApp()
                    .getInstallationById(Long.parseLong(installationId))
                    .createToken()
                    .create();
                
                return GitHub.connectUsingOAuth(token.getToken());
                
            } catch (Exception e) {
                log.warn("GitHub App authentication failed, falling back to PAT: {}", e.getMessage());
            }
        }
        
        // Personal Access Token ÏÇ¨Ïö© (fallback)
        if (githubToken != null && !githubToken.isEmpty()) {
            log.info("üîë Using Personal Access Token authentication");
            return GitHub.connectUsingOAuth(githubToken);
        }
        
        // Ïù∏Ï¶ù Ï†ïÎ≥¥Í∞Ä ÏóÜÎäî Í≤ΩÏö∞
        throw new IOException("No GitHub authentication configured. " +
            "Please set either GitHub App credentials or GITHUB_TOKEN");
    }
    
    private boolean shouldReviewFile(String filename) {
        // Î¶¨Î∑∞Ìï† ÌååÏùº ÌôïÏû•Ïûê Î™©Î°ù
        String[] extensions = {
            ".java", ".kt", ".js", ".ts", ".jsx", ".tsx",
            ".py", ".go", ".rs", ".cpp", ".c", ".cs",
            ".rb", ".php", ".swift", ".scala"
        };
        
        String lowerFilename = filename.toLowerCase();
        
        // Ï†úÏô∏Ìï† Ìå®ÌÑ¥
        if (lowerFilename.contains("/test/") || 
            lowerFilename.contains("/tests/") ||
            lowerFilename.contains(".min.") ||
            lowerFilename.contains("/node_modules/") ||
            lowerFilename.contains("/vendor/") ||
            lowerFilename.contains("/build/") ||
            lowerFilename.contains("/dist/")) {
            return false;
        }
        
        // ÌôïÏû•Ïûê Ï≤¥ÌÅ¨
        for (String ext : extensions) {
            if (lowerFilename.endsWith(ext)) {
                return true;
            }
        }
        
        return false;
    }
}